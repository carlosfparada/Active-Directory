---

# https://www.redhat.com/en/blog/introducing-microsoft-active-directory-inventory-plug-ansible
# https://thecloudmarathoner.com/index.php/2021/10/28/how-to-create-a-free-azure-active-directory-developer-tenant-%F0%9F%A4%94/
# https://github.com/joshinryz/ansible_ldap_inventory/tree/master
- name: Active Directory
  hosts: ad
  connection: winrm
  gather_facts: no
  tasks:

    - name: Get the SID for all user accounts as a LDAP filter
      microsoft.ad.object_info:
        domain_server: "{{ lookup('env','MICROSOFT_AD_LDAP_SERVER') }}"
        domain_username: "{{ lookup('env','MICROSOFT_AD_LDAP_USERNAME') }}"
        domain_password: "{{ lookup('env','MICROSOFT_AD_LDAP_PASSWORD') }}"
        ldap_filter: (&(objectClass=user)(objectCategory=Person))
        properties:
        - objectSid
      ignore_errors: true

    - name: Ensure user bob is present with address information
      microsoft.ad.user:
        domain_server: "{{ lookup('env','MICROSOFT_AD_LDAP_SERVER') }}"
        domain_username: "{{ lookup('env','MICROSOFT_AD_LDAP_USERNAME') }}"
        domain_password: "{{ lookup('env','MICROSOFT_AD_LDAP_PASSWORD') }}"
        auth_protocol: kerberos
        identity: bob
        firstname: Bob
        surname: Smith
        password: B0bP4ssw0rd
        state: present